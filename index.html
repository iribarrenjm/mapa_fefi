<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa de Clubes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #map { height: 90vh; width: 100%; }
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  .controls { padding: 10px; background: #f0f0f0; }
</style>
</head>
<body>

<div class="controls">
  <label for="fechaFiltro">Filtrar por fecha:</label>
  <select id="fechaFiltro">
    <option value="">Todas</option>
  </select>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- PapaParse JS para leer CSV -->
<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

<script>
const csvFile = 'clausura.csv'; // Nombre del archivo CSV en el mismo repo

let mapa = L.map('map').setView([-34.6037, -58.3816], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(mapa);

let marcadores = [];
let fechasUnicas = new Set();
let datosCSV = [];
let campoLat = null, campoLon = null, campoFecha = null;

// Cargar CSV
Papa.parse(csvFile, {
  download: true,
  header: true,
  complete: function(results) {
    datosCSV = results.data.filter(row => Object.keys(row).length > 1);

    // Detectar campos de latitud, longitud y fecha
    let headers = Object.keys(datosCSV[0]);
    campoLat = headers.find(h => h.toLowerCase().includes('lat'));
    campoLon = headers.find(h => h.toLowerCase().includes('lon') || h.toLowerCase().includes('lng') || h.toLowerCase().includes('long'));
    campoFecha = headers.find(h => h.toLowerCase().includes('fecha') || h.toLowerCase().includes('date'));

    // Guardar fechas únicas (si hay campo de fecha)
    if (campoFecha) {
      datosCSV.forEach(row => {
        if (row[campoFecha] && row[campoFecha].trim() !== "") {
          fechasUnicas.add(row[campoFecha].trim());
        }
      });

      // Ordenar fechas de forma ascendente
      let fechasOrdenadas = Array.from(fechasUnicas).sort((a, b) => new Date(a) - new Date(b));
      let select = document.getElementById('fechaFiltro');
      fechasOrdenadas.forEach(fecha => {
        let opt = document.createElement('option');
        opt.value = fecha;
        opt.textContent = fecha;
        select.appendChild(opt);
      });
    }

    mostrarMarcadores();
  }
});

// Mostrar marcadores en el mapa
function mostrarMarcadores(fechaFiltro = "") {
  // Eliminar marcadores existentes
  marcadores.forEach(m => mapa.removeLayer(m));
  marcadores = [];

  datosCSV.forEach(row => {
    let lat = parseFloat(row[campoLat]?.replace(",", "."));
    let lon = parseFloat(row[campoLon]?.replace(",", "."));
    if (!isNaN(lat) && !isNaN(lon)) {
      if (!fechaFiltro || (campoFecha && row[campoFecha] === fechaFiltro)) {
        let popup = '<b>' + (row.Nombre || 'Ubicación') + '</b><br>';
        if (campoFecha && row[campoFecha]) popup += 'Fecha: ' + row[campoFecha] + '<br>';
        popup += `Lat: ${lat}, Lon: ${lon}`;
        let marcador = L.marker([lat, lon]).bindPopup(popup).addTo(mapa);
        marcadores.push(marcador);
      }
    }
  });
}

// Manejar cambio en el filtro
document.getElementById('fechaFiltro').addEventListener('change', function() {
  mostrarMarcadores(this.value);
});
</script>

</body>
</html>
