<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de clubes con filtro por fecha</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- PapaParse para leer CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#0b1020; --fg:#eef2ff; --muted:#a5b4fc; --card:#121936; --accent:#60a5fa; }
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; background:var(--bg); color:var(--fg); }
    header { padding: 12px 16px; background: linear-gradient(180deg, #0b1020, #0e1530); position: sticky; top:0; z-index: 1000; border-bottom: 1px solid rgba(255,255,255,.08); }
    .wrap { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .title { font-size: clamp(16px, 2vw, 20px); font-weight: 700; letter-spacing:.2px; }
    .controls { display:flex; gap:8px; align-items:center; }
    select, button { background:var(--card); color:var(--fg); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px; font-size:14px; }
    select:focus, button:focus { outline:2px solid var(--accent); outline-offset:2px; }
    button { cursor:pointer; }
    #map { height: calc(100% - 64px); }
    .badge { display:inline-block; padding:.15rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted); font-size:12px; }
    .legend { position:absolute; bottom:16px; left:16px; background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px; font-size:12px; box-shadow:0 8px 30px rgba(0,0,0,.25); }
    .popup table { border-collapse: collapse; font-size: 12px; }
    .popup th, .popup td { border: 1px solid #ddd2; padding: 4px 6px; text-align: left; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">üó∫Ô∏è FEFI Clausura 2025 - Fixture Sahores <span id="status" class="badge">Cargando‚Ä¶</span></div>
      <div class="controls" style="margin-left:auto">
        <label for="fechaSelect">Fecha:</label>
        <select id="fechaSelect" disabled>
          <option value="__ALL__">Todas</option>
        </select>
        <button id="btnReset" title="Mostrar todas las fechas" disabled>Reset</button>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <script>
  // ======== Utilidades ========
  const CSV_FILE = new URLSearchParams(location.search).get('csv') || 'clausura.csv';

  function normalizeKey(key){
    return (key||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  }

  function parseLatLng(value){
    if (value == null) return null;
    if (typeof value === 'number') return value;
    // Cambiar coma por punto si es decimal europeo
    const v = value.toString().trim().replace(',', '.');
    const num = Number(v);
    return Number.isFinite(num) ? num : null;
  }

  function looksLikeDateString(v){
    if (v == null) return false;
    const s = String(v).trim();
    if (!s) return false;
    // Acepta formatos comunes: YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY, ISO, etc.
    // Rechaza si tiene demasiadas letras
    if ((s.match(/[a-zA-Z]/g)||[]).length > 6) return false;
    const d = new Date(s);
    return !isNaN(d.getTime());
  }

  function toISODate(v){
    // Convierte a YYYY-MM-DD si es posible; si no, devuelve el string original
    if (!looksLikeDateString(v)) return String(v);
    const d = new Date(v);
    if (isNaN(d.getTime())) return String(v);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function buildPopup(row){
    const keys = Object.keys(row);
    const rows = keys.map(k => {
      const val = row[k] == null ? '' : row[k];
      return `<tr><th>${k}</th><td>${val}</td></tr>`;
    }).join('');
    return `<div class="popup"><table>${rows}</table></div>`;
  }

  // ======== Inicializar mapa ========
  const map = L.map('map');
  const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  map.setView([-34.61, -58.38], 5); // Vista inicial gen√©rica (Argentina)

  const markersLayer = L.layerGroup().addTo(map);

  const statusEl = document.getElementById('status');
  const fechaSelect = document.getElementById('fechaSelect');
  const btnReset = document.getElementById('btnReset');

  // ======== Cargar CSV ========
  Papa.parse(CSV_FILE, {
    header: true,
    download: true,
    dynamicTyping: false, // preferimos parsear manualmente
    skipEmptyLines: true,
    complete: (results) => {
      try {
        const data = results.data || [];
        if (!data.length) throw new Error('El CSV no tiene filas.');

        const sample = data[0];
        const keys = Object.keys(sample);
        const normalized = keys.map(k => ({ raw:k, norm: normalizeKey(k) }));

        // Detectar columnas de lat/lon (acepta variantes)
        const latKeyObj = normalized.find(k => ['lat','latitud','latitude','y'].includes(k.norm));
        const lonKeyObj = normalized.find(k => ['lon','lng','long','longitud','longitude','x'].includes(k.norm));
        if (!latKeyObj || !lonKeyObj) {
          throw new Error('No se encontraron columnas de latitud/longitud. Asegurate de tener campos con nombres que contengan "latitud" y "longitud" (o equivalentes).');
        }
        const LAT = latKeyObj.raw; const LON = lonKeyObj.raw;

        // Detectar columna de fecha
        let fechaKey = null;
        // 1) Preferencia por nombres obvios
        const fechaCandidate = normalized.find(k => k.norm.includes('fecha') || k.norm.includes('date'));
        if (fechaCandidate) fechaKey = fechaCandidate.raw;
        // 2) Si no, buscar una columna donde la mayor√≠a de valores parezcan fecha
        if (!fechaKey){
          for (const k of keys){
            const sampleVals = data.slice(0, Math.min(30, data.length)).map(r => r[k]);
            const score = sampleVals.filter(v => looksLikeDateString(v)).length;
            if (score >= Math.ceil(sampleVals.length * 0.6)) { fechaKey = k; break; }
          }
        }

        // Parsear puntos y fechas normalizadas
        const rows = [];
        for (const r of data){
          const lat = parseLatLng(r[LAT]);
          const lon = parseLatLng(r[LON]);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue; // descartar filas inv√°lidas
          const fechaRaw = fechaKey ? r[fechaKey] : null;
          const fechaISO = fechaKey ? toISODate(fechaRaw) : null;
          rows.push({ __lat: lat, __lon: lon, __fecha: fechaISO, __fechaRaw: fechaRaw, __row: r });
        }

        if (!rows.length) throw new Error('No hay filas v√°lidas con coordenadas num√©ricas.');

        // Construir set de fechas √∫nicas si hay fecha
        const fechasSet = new Set();
        if (fechaKey){
          rows.forEach(o => { if (o.__fecha != null) fechasSet.add(o.__fecha); });
        }

        // Poblar desplegable
        fechaSelect.innerHTML = '<option value="__ALL__">Todas</option>';
        if (fechaKey && fechasSet.size){
          [...fechasSet].sort().forEach(f => {
            const opt = document.createElement('option');
            opt.value = f;
            opt.textContent = f; // mostrar en ISO YYYY-MM-DD
            fechaSelect.appendChild(opt);
          });
          fechaSelect.disabled = false;
          btnReset.disabled = false;
          statusEl.textContent = `Listo ‚Äî ${rows.length} puntos, filtro: ${fechaKey}`;
        } else {
          fechaSelect.disabled = true;
          btnReset.disabled = true;
          statusEl.textContent = `Listo ‚Äî ${rows.length} puntos (sin columna de fecha)`;
        }

        // Render inicial
        function render(selected){
          markersLayer.clearLayers();
          const toShow = rows.filter(o => {
            if (!selected || selected === '__ALL__' || !fechaKey) return true;
            return o.__fecha === selected;
          });
          const bounds = [];
          toShow.forEach(o => {
            const marker = L.marker([o.__lat, o.__lon]);
            marker.bindPopup(buildPopup(o.__row));
            marker.addTo(markersLayer);
            bounds.push([o.__lat, o.__lon]);
          });
          if (bounds.length){
            try { map.fitBounds(bounds, { padding: [30,30] }); } catch(e) {}
          }
          statusEl.textContent = fechaKey ? `Mostrando ${toShow.length} / ${rows.length} puntos ‚Äî fecha: ${selected === '__ALL__' ? 'Todas' : selected}`
                                          : `Mostrando ${toShow.length} puntos`;
        }

        fechaSelect.addEventListener('change', () => render(fechaSelect.value));
        btnReset.addEventListener('click', () => { fechaSelect.value='__ALL__'; render('__ALL__'); });

        render('__ALL__');
      } catch(err){
        console.error(err);
        statusEl.textContent = 'Error';
        alert('Error procesando el CSV: ' + err.message);
      }
    },
    error: (err) => {
      console.error(err);
      statusEl.textContent = 'Error';
      alert('No se pudo descargar el CSV ¬´' + CSV_FILE + '¬ª.\nAsegurate de subirlo al mismo repositorio y rama que este index.html.');
    }
  });
  </script>
</body>
</html>
